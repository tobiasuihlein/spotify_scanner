import os
import requests
import json
import base64
from dotenv import load_dotenv
from time import sleep

load_dotenv()

class SpotifyAPI:
    def __init__(self):
        self.client_id = os.getenv('SPOTIFY_CLIENT_ID')
        self.client_secret = os.getenv('SPOTIFY_CLIENT_SECRET')
        self.token = self.get_token()

    def get_token(self):
        auth_string = f"{self.client_id}:{self.client_secret}"
        auth_bytes = auth_string.encode("utf-8")
        auth_base64 = str(base64.b64encode(auth_bytes), "utf-8")
        
        url = "https://accounts.spotify.com/api/token"
        headers = {
            "Authorization": f"Basic {auth_base64}",
            "Content-Type": "application/x-www-form-urlencoded"
        }
        data = {"grant_type": "client_credentials"}
        
        result = requests.post(url, headers=headers, data=data)
        json_result = json.loads(result.content)
        return json_result["access_token"]

    def get_track_info(self, track_id):
        """Get detailed track info including preview URL"""
        track_url = f"https://api.spotify.com/v1/tracks/{track_id}"
        headers = {"Authorization": f"Bearer {self.token}"}
        
        track_result = requests.get(track_url, headers=headers)
        track_json = json.loads(track_result.content)
        
        if "error" in track_json:
            raise Exception(f"Track fetch error: {track_json['error']['message']}")
        
        return {
            "id": track_json["id"],
            "title": track_json["name"],
            "artist": track_json["artists"][0]["name"],
            "preview_url": track_json["preview_url"],
            "year": track_json["album"]["release_date"][:4],
            "spotify_url": track_json["external_urls"]["spotify"]
        }

def create_hiphop_playlist():
    # Initialize Spotify API
    spotify = SpotifyAPI()
    
    # Base track list with IDs (same as before but only IDs initially)
    track_ids = [
        # 1980s
        "0FWhGmPVxLI6jOVF0wjABA",  # Rapper's Delight
        "5DuTNKFEjJIySAyJH1ykvk",  # The Message
        "5SZ6zX4rOrEQferfFC2MfP",  # Walk This Way
        "5DD4qHf36VqlPkYuQDhHoQ",  # Push It
        "2ZXvmcqXiKkhHRnWrBnZAJ",  # Paid in Full
        "5HQkjFYbKAxE31UhYpF6G7",  # Children's Story
        "3qT4bUD1MaWpGrTwcvguhb",  # Straight Outta Compton
        "1yo16b3u0lptm6Cs7lx4AD",  # Fight the Power
        
        # 1990s
        "0jD8x0Fz1UNnWmGM45YK0F",  # Scenario
        "0bf9iOB0JvPUpRLaLKnveE",  # Nuthin' but a 'G' Thang
        "119c93MHjrDLJTApCVGpvx",  # C.R.E.A.M.
        "4VrWlk8IQxevMvERoX08iC",  # Gin and Juice
        "5ByAIlEEnxYdvpnezg7HTX",  # Juicy
        "77UjLW8j5UAGAGVGhR5oUK",  # California Love
        "3q2v0fAAZnK7EQKZjXpS6z",  # Fu-Gee-La
        "4r9kMolXX8LQpwvYjEK2Dm",  # Hard Knock Life
        
        # 2000s
        "3yfqSUWxFvZELEM4PmlwIR",  # The Real Slim Shady
        "0I3q5fE6wg7LIfHGngUTnV",  # Ms. Jackson
        "7MJQ9Nfxzh8LPZ9e9u68Fq",  # Lose Yourself
        "7iL6o9tox1zgHpKUfh9vuC",  # In Da Club
        "2PpruBYCo4H7WOBJ7Q2EwM",  # Hey Ya!
        "1PS1QMdUqOal0ai3Gt7sDQ",  # Gold Digger
        "4fzsfWzRhPawzqhX8Qt9F3",  # Stronger
        "2igwFfvr1OAGX9SKDCPBwO",  # Empire State of Mind
        
        # 2010s
        "22L7bfCiAkJo5xGSQgmiIO",  # All of the Lights
        "62vpWI1CHwFy7tMIcSStl8",  # No Role Modelz
        "3kxfsdsCpFgN412fpnW85Y",  # Alright
        "6nmz4imkDcmtwMjocAzFSx",  # Hotline Bling
        "6HZILIRieu8S0iqY8kIKhj",  # DNA.
        "2xLMifQCjDGFmkHkpNLD9h",  # Sicko Mode
        "6DCZcSspjsKoFjzjrWoCdn",  # God's Plan
        "0b9oOr2ZgvyQu88wzixux9",  # This Is America
        
        # 2020s
        "4Oun2ylbjFKMPTiaSbbCih",  # WAP
        "39j8ZzWl4YS35OyMvMEG7q",  # THE SCOTTS
        "43PGPuHIlVSXIwodMx4rXT",  # RAPSTAR
        "5Z9KJZvQzH6PFmb8SNkxuk",  # Industry Baby
        "0fX4oNGBWO3dSGUZcVdVV2",  # N95
        "59nOXPmaKlBfGMDeOVGrIK",  # Wait for U
        "1bDbXMyjaUIooNwFE9wn0N"   # Rich Flex
    ]
    
    # Fetch full track info including preview URLs
    tracks = []
    total_tracks = len(track_ids)
    
    print(f"Fetching track information for {total_tracks} tracks...")
    
    for i, track_id in enumerate(track_ids, 1):
        try:
            track_info = spotify.get_track_info(track_id)
            if track_info["preview_url"]:  # Only add tracks with preview URLs
                tracks.append(track_info)
                print(f"✓ [{i}/{total_tracks}] Added: {track_info['title']} by {track_info['artist']}")
            else:
                print(f"✗ [{i}/{total_tracks}] Skipped: No preview URL available for track {track_id}")
            
            # Add a small delay to avoid rate limiting
            sleep(0.1)
            
        except Exception as e:
            print(f"✗ [{i}/{total_tracks}] Error fetching track {track_id}: {str(e)}")
    
    # Create playlist data structure
    playlist_data = {
        "hiphop_classics": {
            "playlist_name": "Hip-Hop Classics Through the Decades",
            "tracks": tracks
        }
    }
    
    # Save to JSON file
    output_file = 'hiphop_classics.json'
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(playlist_data, f, indent=4, ensure_ascii=False)
    
    # Print statistics
    print(f"\nCreated playlist JSON file with {len(tracks)} tracks")
    print(f"Output file: {output_file}")
    
    # Count songs by decade
    decades = {}
    for track in tracks:
        decade = f"{track['year'][:3]}0s"
        decades[decade] = decades.get(decade, 0) + 1
    
    print("\nTracks by decade:")
    for decade in sorted(decades.keys()):
        print(f"{decade}: {decades[decade]} tracks")

if __name__ == "__main__":
    # Check for environment variables
    required_vars = ['SPOTIFY_CLIENT_ID', 'SPOTIFY_CLIENT_SECRET']
    missing_vars = [var for var in required_vars if not os.getenv(var)]
    
    if missing_vars:
        print("\nError: Missing required environment variables:")
        print("Please create a .env file with the following variables:")
        for var in missing_vars:
            print(f"- {var}")
        print("\nYou can get these credentials from the Spotify Developer Dashboard:")
        print("https://developer.spotify.com/dashboard")
        exit(1)
    
    create_hiphop_playlist()